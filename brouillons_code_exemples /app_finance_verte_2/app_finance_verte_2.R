
required_packages <- c(
    "checkpoint",
    "shinydashboard"
)

# install missing packages

new.packages <- required_packages[!(required_packages %in% installed.packages()[,"Package"])]

if (length(new.packages)) {
    install.packages(new.packages)
}

rm(new.packages)

library(checkpoint)
checkpoint(snapshotDate ='2019-12-17')
library(shiny)
library(shinydashboard)

# Define UI for application 
ui <- fluidPage(
    # dashboardHeader(title = "Un aperçu de la finance verte et des investissements pour le climat en France"),
    
    titlePanel("Un aperçu de la finance verte et des investissements pour le climat en France"),
    mainPanel(
    
    # dashboardSidebar(),
    # dashboardBody(
    #     
    #     tabItems(
    #         ##  Main dashboard ----------------------------------------------------------
    #         tabItem( tabName = 'dashboard',
    #                  
    #         ),
            
            h2(paste0("Les investissements pour le climat")) ,
            fluidRow(
                valueBoxOutput("inv_2016_2018_box"),
                valueBoxOutput("inv_2019_2023_box"),
                valueBoxOutput("inv_2024_2028_box")
            ),
            
            h2(paste0("Investissements par secteurs")),
            fluidRow(column( width = 12,h4("Montants annuels actuels", align = 'center'), plotlyOutput('plot_inv_secteurs_1')),
            fluidRow(column( width = 12,h4("Nouveaux objectifs actuels", align = 'center'), plotlyOutput('plot_inv_secteurs_2')),
            fluidRow(column( width = 12,h4("Investissements annuels supplémentaires générés espérés", align = 'center'), plotlyOutput('plot_inv_secteurs_3'))
            ),
        ) 
    )
    
 )

)
    


# Define server logic 
server <- function(input, output) {
    
    #Données sur les investissements et besoins d'investissements par période
    
    # inv_2016_2018 <- dfinv_1 %>%
    #     filter( annee_debut_periode == 2016) %>%
    #     dplyr::select(Investissements_annuels_en_milliards_euros) %>%
    #     as.numeric
    # 
    # inv_2019_2013 <- dfinv_1 %>%
    #     filter( annee_debut_periode == 2019) %>%
    #     dplyr::select(Investissements_annuels_en_milliards_euros) %>%
    #     as.numeric
    # 
    # inv_2024_2028 <- dfinv_1 %>%
    #     filter( annee_debut_periode == 2024) %>%
    #     dplyr::select(Investissements_annuels_en_milliards_euros) %>%
    #     as.numeric
    # 
    # output$inv_2016_2018_box <- renderValueBox({
    #     valueBox(
    #         VB_style( paste0(format( inv_2016_2018,big.mark=','), " mds€" ),  "font-size: 60%;"  ),
    #         VB_style( paste0("2016-2018")  ), 
    #         color = "green"
    #     )
    # })
    # 
    # output$inv_2019_2023_box <- renderValueBox({
    #     valueBox(
    #         VB_style( paste0(format( inv_2019_2023,big.mark=','), " mds€" ),  "font-size: 60%;"  ),
    #         VB_style( paste0("2019-2023")  ), 
    #         color = "green"
    #     )
    # })
    # 
    # output$inv_2024_2028_box <- renderValueBox({
    #     valueBox(
    #         VB_style( paste0(format( inv_2024_2028,big.mark=','), " mds€" ),  "font-size: 60%;"  ),
    #         VB_style( paste0("2024-2028")  ), 
    #         color = "green"
    #     )
    # })
    # 

  #Figures sur les investissements par secteurs 
    
    output$plot_inv_secteurs_1 <- renderPlotly({
       plot_inv_secteurs_1 <-
            ggplot(dfinv_2, 
                   aes(x= Montant_financement_public_annuel_actuel, 
                       y = 0, 
                       group = Secteur, 
                       text = Secteur
                       )) +
            geom_point(aes(size = Montant_financement_public_annuel_actuel , fill = Secteur), 
                       alpha = 0.6, 
                       color = "black", 
                       shape = 21) +
            coord_cartesian(ylim = c(-2, 2)) +
            scale_size_area(max_size = 25) +
            guides(fill = FALSE, size = FALSE) +
            labs(x = "Montant en milliards d'euros /n (balayer avec la souris pour voir les secteurs)") +
            scale_x_continuous(
                name = "Montant en milliards d'euros (balayer avec la souris pour voir les secteurs)", 
                trans = "log10", 
                breaks = c(0.5,1,1.5,1.6,1.7,1.8,1.9,2)) +
            scale_fill_viridis_d() + 
            theme(
                panel.grid.major = element_line(color = "lightgrey", size = 0.2),
                panel.grid.major.y = element_blank(),
                panel.background = element_rect(fill = "white"),
                axis.text.y = element_blank(),
                axis.text.x = element_text(size = 6),
                axis.title.x = element_text(size = 10, margin = margin(t = 10)),
                axis.title.y = element_blank(),
                axis.ticks.y = element_blank(),
                plot.title = element_text(size = 10, hjust = 0),
                panel.border = element_rect(colour = "darkgrey", fill = NA, size = 1)
            )
        
        
        style(
            hide_legend(
                ggplotly(tooltip = c("text", "Count"))), 
            hoverlabel = list(bgcolor = "white")
        )
    })
    
    output$plot_inv_secteurs_2 <- renderPlotly({
        plot_inv_secteurs_2 <-
            ggplot(dfinv_2, 
                   aes(x=Nouvel_objectif_annuel, 
                       y = 0, 
                       group = Secteur, 
                       text = Secteur
                   )) +
            geom_point(aes(size = Nouvel_objectif_annuel , fill = Secteur), 
                       alpha = 0.6, 
                       color = "green", 
                       shape = 21) +
            coord_cartesian(ylim = c(-2, 2)) +
            scale_size_area(max_size = 25) +
            guides(fill = FALSE, size = FALSE) +
            labs(x = "Montant en milliards d'euros /n (balayer avec la souris pour voir les secteurs)") +
            scale_x_continuous(
                name = "Montant en milliards d'euros (balayer avec la souris pour voir les secteurs)", 
                trans = "log10", 
                breaks = c(0.5,1,1.5,2,2.5,3)) +
            scale_fill_viridis_d() + 
            theme(
                panel.grid.major = element_line(color = "lightgrey", size = 0.2),
                panel.grid.major.y = element_blank(),
                panel.background = element_rect(fill = "white"),
                axis.text.y = element_blank(),
                axis.text.x = element_text(size = 6),
                axis.title.x = element_text(size = 10, margin = margin(t = 10)),
                axis.title.y = element_blank(),
                axis.ticks.y = element_blank(),
                plot.title = element_text(size = 10, hjust = 0),
                panel.border = element_rect(colour = "darkgrey", fill = NA, size = 1)
            )
        
        
        style(
            hide_legend(
                ggplotly(tooltip = c("text", "Count"))), 
            hoverlabel = list(bgcolor = "white")
        )
    })
 
    
    
    
}

# Run the application 
shinyApp(ui = ui, server = server)
